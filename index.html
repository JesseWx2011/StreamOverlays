<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Weather Alert Ticker</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body, html {
            width: 100%;
            height: 100%;
            font-family: 'Segoe UI', Roboto, Arial, sans-serif;
            background: transparent;
            overflow: hidden;
        }

        #alert-display {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            flex-direction: column;
            background-color: #5d5d5d;
            padding: 5px;
            box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.9);
        }

        #alert-expiration {
            width: 100%;
            text-align: center;
            background-color: rgb(82, 82, 82);
            padding: 8px;
            font-size: 16px;
            text-transform: uppercase;
            font-weight: bold;
            text-shadow: 1px 1px 2px black;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            border-bottom: 2px solid #3a3a3a;
        }

        .alert-content {
            display: flex;
            width: 100%;
            height: 50px;
            background-color: #4d4d4d;
            position: relative;
            overflow: hidden;
        }

        #alert-type {
            width: 25%;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 15px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px black;
            background-color: #2b2b2b;
            text-transform: uppercase;
            border-right: 2px solid #3a3a3a;
            transition: background-color 0.8s ease;
            position: relative;
            overflow: hidden;
        }

        .alert-type-text {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .alert-type-text.slide-out {
            transform: translateY(-100%);
        }

        .alert-type-text.slide-in {
            transform: translateY(100%);
        }

        .alert-type-text.active {
            transform: translateY(0);
        }

        #alert-areas {
            flex: 1;
            background-color: #808080;
            display: flex;
            align-items: center;
            padding: 0 15px;
            font-size: 16px;
            color: white;
            text-shadow: 1px 1px 2px black;
            text-transform: uppercase;
            overflow: hidden;
            font-weight: 800;
            position: relative;
        }

        .scrolling-text-container {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            transition: transform 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .scrolling-text-container.slide-out {
            transform: translateY(-100%);
        }

        .scrolling-text-container.slide-in {
            transform: translateY(100%);
        }

        .scrolling-text-container.active {
            transform: translateY(0);
        }

        .scrolling-text {
            white-space: nowrap;
            animation: scroll 30s linear infinite;
            padding-left: 100%;
        }

        @keyframes scroll {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }

        /* Alert Type Colors */
        .color-tornado {
            background-color: #8e44ad !important;
        }

        .color-severe-thunderstorm {
            background-color: #c0392b !important;
        }

        .color-flash-flood {
            background-color: #2980b9 !important;
        }

        .color-blizzard {
            background-color: #ecf0f1 !important;
            color: #2c3e50 !important;
        }

        .color-winter-storm {
            background-color: #3498db !important;
        }

        .color-ice-storm {
            background-color: #74b9ff !important;
        }

        .color-winter-weather {
            background-color: #5f9ea0 !important;
        }

        .color-freeze {
            background-color: #1e3a8a !important;
        }

        .color-wind-chill {
            background-color: #7f8c8d !important;
        }

        .color-winter {
            background-color: #34495e !important;
        }

        .color-default {
            background-color: #2b2b2b !important;
        }

        /* Loading state */
        .loading {
            text-align: center;
            font-style: italic;
            opacity: 0.7;
        }
    </style>
</head>
<body>

    <div id="alert-display">
        <div id="alert-expiration">
            <i class="far fa-clock"></i>&nbsp;&nbsp;Loading alerts...
        </div>
        <div class="alert-content">
            <div id="alert-type">
                <div class="alert-type-text active">SCANNING</div>
            </div>
            <div id="alert-areas">
                <div class="scrolling-text-container active">
                    <div class="scrolling-text">Connecting to NWS API...</div>
                </div>
            </div>
        </div>
    </div>

<script>
    let alerts = [];
    let currentIndex = 0;
    let cycleInterval = null;
    let knownAlertIds = new Set();
    let knownAlertVTEC = new Map();

    async function fetchAlerts() {
        try {
            const res = await fetch('https://api.weather.gov/alerts/active');
            const data = await res.json();
            
            // Define which alert types we support with themes
            const supportedAlerts = [
                'tornado', 'thunderstorm', 'flood', 'blizzard', 'winter storm',
                'ice storm', 'winter weather', 'freeze', 'frost', 'wind chill',
                'extreme cold', 'winter'
            ];
            
            // Filter for supported alerts and sort by priority
            alerts = data.features
                .filter(a => {
                    const ev = a.properties.event.toLowerCase();
                    return supportedAlerts.some(type => ev.includes(type));
                })
                .sort((a, b) => {
                    const p = ["Tornado Warning", "Severe Thunderstorm Warning", "Flash Flood Warning"];
                    return p.indexOf(b.properties.event) - p.indexOf(a.properties.event);
                });

            console.log(`Found ${alerts.length} alerts`);

            // Start rendering if not already cycling
            if (!cycleInterval && alerts.length > 0) {
                renderAlert(0);
                startCycling();
            } else if (alerts.length === 0) {
                showNoAlerts();
            }
        } catch (e) { 
            console.error("API Error", e);
            showError();
        }
    }

    function getColorClass(eventName) {
        const ev = eventName.toLowerCase();
        
        if (ev.includes('tornado')) return 'color-tornado';
        if (ev.includes('severe thunderstorm')) return 'color-severe-thunderstorm';
        if (ev.includes('flash flood') || ev.includes('flood')) return 'color-flash-flood';
        if (ev.includes('blizzard')) return 'color-blizzard';
        if (ev.includes('winter storm')) return 'color-winter-storm';
        if (ev.includes('ice storm')) return 'color-ice-storm';
        if (ev.includes('winter weather')) return 'color-winter-weather';
        if (ev.includes('freeze') || ev.includes('frost')) return 'color-freeze';
        if (ev.includes('wind chill') || ev.includes('extreme cold')) return 'color-wind-chill';
        if (ev.includes('winter')) return 'color-winter';
        
        return 'color-default';
    }

    function formatAreasWithState(properties) {
        let areaDesc = properties.areaDesc || 'Information not available';
        
        if (properties.geocode && properties.geocode.UGC) {
            const ugcCodes = properties.geocode.UGC;
            const states = new Set();
            
            ugcCodes.forEach(code => {
                if (code.length >= 2) {
                    const stateCode = code.substring(0, 2);
                    states.add(stateCode);
                }
            });
            
            if (states.size > 0) {
                const stateList = Array.from(states).join(', ');
                return `${areaDesc} (${stateList})`;
            }
        }
        
        return areaDesc;
    }

    function renderAlert(index, animate = false) {
        if (!alerts[index]) return;
        currentIndex = index;
        const alert = alerts[index];
        const p = alert.properties;

        const expires = new Date(p.expires);
        const expiresText = expires.toLocaleString([], {
            month: 'numeric',
            day: 'numeric',
            year: '2-digit',
            hour: 'numeric',
            minute: '2-digit',
            timeZoneName: 'short'
        });

        const eventName = p.event;
        const areasText = formatAreasWithState(p);
        const colorClass = getColorClass(eventName);

        if (animate) {
            // Animate the transition
            animateAlertChange(eventName, areasText, colorClass, expiresText);
        } else {
            // Direct update (first load)
            updateAlertDirect(eventName, areasText, colorClass, expiresText);
        }
    }

    function updateAlertDirect(eventName, areasText, colorClass, expiresText) {
        const alertType = document.getElementById('alert-type');
        const alertExpiration = document.getElementById('alert-expiration');
        
        // Update expiration
        alertExpiration.innerHTML = `<i class="far fa-clock"></i>&nbsp;&nbsp;Expires: ${expiresText}`;
        
        // Update alert type
        alertType.className = colorClass;
        alertType.innerHTML = `<div class="alert-type-text active">${eventName}</div>`;
        
        // Update areas
        const alertAreas = document.getElementById('alert-areas');
        alertAreas.innerHTML = `
            <div class="scrolling-text-container active">
                <div class="scrolling-text">${areasText} • ${areasText} • ${areasText}</div>
            </div>
        `;
    }

    function animateAlertChange(eventName, areasText, colorClass, expiresText) {
        const alertType = document.getElementById('alert-type');
        const alertAreas = document.getElementById('alert-areas');
        const alertExpiration = document.getElementById('alert-expiration');
        
        // Get current elements
        const currentTypeText = alertType.querySelector('.alert-type-text.active');
        const currentAreasContainer = alertAreas.querySelector('.scrolling-text-container.active');
        
        // Slide out current content
        if (currentTypeText) {
            currentTypeText.classList.remove('active');
            currentTypeText.classList.add('slide-out');
        }
        
        if (currentAreasContainer) {
            currentAreasContainer.classList.remove('active');
            currentAreasContainer.classList.add('slide-out');
        }
        
        // Create new elements
        const newTypeText = document.createElement('div');
        newTypeText.className = 'alert-type-text slide-in';
        newTypeText.textContent = eventName;
        
        const newAreasContainer = document.createElement('div');
        newAreasContainer.className = 'scrolling-text-container slide-in';
        newAreasContainer.innerHTML = `<div class="scrolling-text">${areasText} • ${areasText} • ${areasText}</div>`;
        
        // Add new elements
        alertType.appendChild(newTypeText);
        alertAreas.appendChild(newAreasContainer);
        
        // Trigger transition to color
        setTimeout(() => {
            alertType.className = colorClass;
        }, 100);
        
        // Slide in new content
        setTimeout(() => {
            newTypeText.classList.remove('slide-in');
            newTypeText.classList.add('active');
            newAreasContainer.classList.remove('slide-in');
            newAreasContainer.classList.add('active');
            
            // Update expiration with fade
            alertExpiration.style.opacity = '0';
            setTimeout(() => {
                alertExpiration.innerHTML = `<i class="far fa-clock"></i>&nbsp;&nbsp;Expires: ${expiresText}`;
                alertExpiration.style.opacity = '1';
            }, 300);
        }, 50);
        
        // Clean up old elements after animation
        setTimeout(() => {
            if (currentTypeText) currentTypeText.remove();
            if (currentAreasContainer) currentAreasContainer.remove();
        }, 700);
    }

    function showNoAlerts() {
        const alertExpiration = document.getElementById('alert-expiration');
        const alertType = document.getElementById('alert-type');
        const alertAreas = document.getElementById('alert-areas');
        
        alertExpiration.innerHTML = '<i class="fas fa-check-circle"></i>&nbsp;&nbsp;No Active Alerts';
        alertType.className = 'color-default';
        alertType.innerHTML = '<div class="alert-type-text active">ALL CLEAR</div>';
        alertAreas.innerHTML = '<div class="scrolling-text-container active"><div class="scrolling-text">No weather alerts at this time</div></div>';
    }

    function showError() {
        const alertExpiration = document.getElementById('alert-expiration');
        alertExpiration.innerHTML = '<i class="fas fa-exclamation-triangle"></i>&nbsp;&nbsp;Error Loading Alerts';
    }

    function startCycling() {
        if (cycleInterval) clearInterval(cycleInterval);
        
        cycleInterval = setInterval(() => {
            if (alerts.length > 1) {
                const nextIndex = (currentIndex + 1) % alerts.length;
                renderAlert(nextIndex, true);
            }
        }, 15000); // Cycle every 15 seconds
    }

    // Fetch alerts every 60 seconds
    setInterval(fetchAlerts, 60000);
    fetchAlerts();

    // Add transition to expiration element
    document.getElementById('alert-expiration').style.transition = 'opacity 0.3s ease';
</script>
</body>
</html>
